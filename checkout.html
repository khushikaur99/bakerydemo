<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Your Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Checkout</h1>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Column - Form Sections -->
            <div class="lg:w-2/3 space-y-6">
                <!-- Login Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="fas fa-user-circle mr-2 text-blue-500"></i>Account Information
                    </h2>
                    
                    <div class="space-y-4" id="account-section">
                        <div id="logged-in-user" class="hidden">
                            <p class="text-sm text-gray-600">Logged in as: <span id="user-email" class="font-medium"></span></p>
                            <button id="logout-btn" class="mt-2 text-blue-600 text-sm hover:underline">Not you? Log out</button>
                        </div>
                        
                        <div id="login-form">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
                                <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="your@email.com" required>
                            </div>
                            
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password*</label>
                                <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="••••••••" required>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="remember" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="remember" class="ml-2 block text-sm text-gray-700">Remember me</label>
                            </div>
                            
                            <button id="login-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                                Login
                            </button>
                            
                            <p class="text-center text-sm text-gray-600">or</p>
                            
                            <button id="guest-checkout-btn" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-50 transition duration-200">
                                Continue as Guest
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Location & Address Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>Delivery Location & Address
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Your Location*</label>
                            <div class="flex gap-2 mb-4">
                                <select id="delivery-location" class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Choose a city</option>
                                    <option value="Pune">Pune</option>
                                    <option value="Mumbai">Mumbai</option>
                                    <option value="Bangalore">Bangalore</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Hyderabad">Hyderabad</option>
                                    <option value="Chennai">Chennai</option>
                                    <option value="Kolkata">Kolkata</option>
                                </select>
                                <button id="use-current-location" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-location-arrow mr-1"></i>Current Location
                                </button>
                            </div>
                            
                            <!-- Map Container -->
                            <div id="map" class="w-full h-64 rounded-md border border-gray-300 mb-4"></div>
                            
                            <div class="text-sm text-gray-600">
                                <p id="selected-location-text">Selected Location: <span id="current-location" class="font-medium">None selected</span></p>
                                <p class="mt-1">Estimated Delivery Time: <span id="delivery-estimate" class="font-medium text-blue-600">Select location first</span></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="first-name" class="block text-sm font-medium text-gray-700 mb-1">First Name*</label>
                                <input type="text" id="first-name" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="last-name" class="block text-sm font-medium text-gray-700 mb-1">Last Name*</label>
                                <input type="text" id="last-name" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Street Address*</label>
                            <input type="text" id="address" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        
                        <div>
                            <label for="address2" class="block text-sm font-medium text-gray-700 mb-1">Apartment, suite, etc. (optional)</label>
                            <input type="text" id="address2" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City*</label>
                                <input type="text" id="city" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" readonly>
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State*</label>
                                <input type="text" id="state" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" readonly>
                            </div>
                            <div>
                                <label for="zip" class="block text-sm font-medium text-gray-700 mb-1">ZIP Code*</label>
                                <input type="text" id="zip" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number*</label>
                            <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Date & Time Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="far fa-calendar-alt mr-2 text-blue-500"></i>Delivery Date & Time
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="delivery-date" class="block text-sm font-medium text-gray-700 mb-1">Delivery Date*</label>
                                <input type="date" id="delivery-date" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="delivery-time" class="block text-sm font-medium text-gray-700 mb-1">Delivery Time*</label>
                                <select id="delivery-time" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                    <option value="">Select Time Slot</option>
                                    <option value="morning">Morning (9AM - 12PM)</option>
                                    <option value="afternoon">Afternoon (12PM - 4PM)</option>
                                    <option value="evening">Evening (4PM - 8PM)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Options*</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input id="standard-delivery" name="delivery-type" type="radio" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" value="standard">
                                    <label for="standard-delivery" class="ml-2 block text-sm text-gray-700">
                                        Standard Delivery (Free)
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input id="express-delivery" name="delivery-type" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" value="express">
                                    <label for="express-delivery" class="ml-2 block text-sm text-gray-700">
                                        Express Delivery (+₹99)
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input id="scheduled-delivery" name="delivery-type" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" value="scheduled">
                                    <label for="scheduled-delivery" class="ml-2 block text-sm text-gray-700">
                                        Scheduled Delivery (+₹49)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Special Note Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="far fa-sticky-note mr-2 text-blue-500"></i>Special Note
                    </h2>
                    
                    <div>
                        <label for="special-note" class="block text-sm font-medium text-gray-700 mb-1">Additional Instructions</label>
                        <textarea id="special-note" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Any special instructions for delivery..."></textarea>
                    </div>
                </div>
                
                <!-- Payment Section -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="far fa-credit-card mr-2 text-blue-500"></i>Payment Method
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <input id="credit-card" name="payment-method" type="radio" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="credit-card" class="ml-2 block text-sm text-gray-700">
                                    Credit/Debit Card
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="paypal" name="payment-method" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="paypal" class="ml-2 block text-sm text-gray-700">
                                    UPI Payment
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="apple-pay" name="payment-method" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="apple-pay" class="ml-2 block text-sm text-gray-700">
                                    Net Banking
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input id="cod" name="payment-method" type="radio" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="cod" class="ml-2 block text-sm text-gray-700">
                                    Cash on Delivery (+₹20)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Credit Card Form -->
                        <div id="credit-card-form" class="space-y-4">
                            <div>
                                <label for="card-number" class="block text-sm font-medium text-gray-700 mb-1">Card Number*</label>
                                <input type="text" id="card-number" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="1234 5678 9012 3456" required>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="card-expiry" class="block text-sm font-medium text-gray-700 mb-1">Expiration Date*</label>
                                    <input type="text" id="card-expiry" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="MM/YY" required>
                                </div>
                                <div>
                                    <label for="card-cvc" class="block text-sm font-medium text-gray-700 mb-1">CVV*</label>
                                    <input type="text" id="card-cvc" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="123" required>
                                </div>
                            </div>
                            
                            <div>
                                <label for="card-name" class="block text-sm font-medium text-gray-700 mb-1">Name on Card*</label>
                                <input type="text" id="card-name" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        
                        <!-- UPI Form -->
                        <div id="upi-form" class="hidden">
                            <div>
                                <label for="upi-id" class="block text-sm font-medium text-gray-700 mb-1">UPI ID*</label>
                                <input type="text" id="upi-id" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="yourname@upi">
                            </div>
                            <p class="text-sm text-gray-500 mt-2">You will be redirected to your UPI app to complete the payment</p>
                        </div>
                        
                        <!-- Net Banking Form -->
                        <div id="netbanking-form" class="hidden">
                            <div>
                                <label for="bank-select" class="block text-sm font-medium text-gray-700 mb-1">Select Bank*</label>
                                <select id="bank-select" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select your bank</option>
                                    <option value="sbi">State Bank of India</option>
                                    <option value="hdfc">HDFC Bank</option>
                                    <option value="icici">ICICI Bank</option>
                                    <option value="axis">Axis Bank</option>
                                    <option value="kotak">Kotak Mahindra Bank</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- COD Notice -->
                        <div id="cod-form" class="hidden">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                <div class="flex">
                                    <i class="fas fa-info-circle text-yellow-400 mr-2 mt-0.5"></i>
                                    <div>
                                        <h4 class="text-sm font-medium text-yellow-800">Cash on Delivery</h4>
                                        <p class="text-sm text-yellow-700 mt-1">Pay with cash when your order is delivered. An extra ₹20 handling charge will be added to your total.</p>
                                        <p class="text-xs text-yellow-600 mt-2">Please keep exact change ready for a smooth delivery experience.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Order Summary -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">
                        <i class="fas fa-receipt mr-2 text-blue-500"></i>Order Summary
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal (<span id="item-count">0</span> items)</span>
                            <span class="font-medium">₹<span id="subtotal">0.00</span></span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-medium">₹<span id="shipping-cost">0.00</span></span>
                        </div>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tax</span>
                            <span class="font-medium">₹<span id="tax">0.00</span></span>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-4 flex justify-between text-lg font-semibold">
                            <span>Total</span>
                            <span>₹<span id="total">0.00</span></span>
                        </div>
                        
                        <div class="pt-4">
                            <button id="place-order-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition duration-200 font-medium">
                                Place Order
                            </button>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            By placing your order, you agree to our <a href="#" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="#" class="text-blue-600 hover:underline">Privacy Policy</a>.
                        </p>
                    </div>
                    
                    <!-- Order Items -->
                    <div class="mt-6 border-t border-gray-200 pt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Your Items</h3>
                        
                        <div class="space-y-4" id="order-items">
                            <!-- Items will be populated from product details -->
                            <p class="text-sm text-gray-500" id="no-items-message">No items in cart</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let marker;
        let userLocation = { lat: 18.5204, lng: 73.8567 }; // Default to Pune
        
        // City coordinates and delivery info
        const cityData = {
            'Pune': { 
                lat: 18.5204, lng: 73.8567, state: 'Maharashtra',
                deliveryDays: '1-2 days', expressAvailable: true
            },
            'Mumbai': { 
                lat: 19.0760, lng: 72.8777, state: 'Maharashtra',
                deliveryDays: '1-2 days', expressAvailable: true
            },
            'Bangalore': { 
                lat: 12.9716, lng: 77.5946, state: 'Karnataka',
                deliveryDays: '2-3 days', expressAvailable: true
            },
            'Delhi': { 
                lat: 28.7041, lng: 77.1025, state: 'Delhi',
                deliveryDays: '2-3 days', expressAvailable: true
            },
            'Hyderabad': { 
                lat: 17.3850, lng: 78.4867, state: 'Telangana',
                deliveryDays: '2-4 days', expressAvailable: false
            },
            'Chennai': { 
                lat: 13.0827, lng: 80.2707, state: 'Tamil Nadu',
                deliveryDays: '3-4 days', expressAvailable: false
            },
            'Kolkata': { 
                lat: 22.5726, lng: 88.3639, state: 'West Bengal',
                deliveryDays: '3-5 days', expressAvailable: false
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Product data from URL parameters or memory
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            let cartItems = getStoredCartItems();
            
            // If coming from product page with a productId, add to cart
            if (productId && !cartItems.some(item => item.id === productId)) {
                const product = getProductDetails(productId);
                if (product) {
                    cartItems.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        color: product.color || 'Default',
                        size: product.size || 'Standard',
                        quantity: 1
                    });
                    storeCartItems(cartItems);
                }
            }
            
            // Initialize the page
            initPage();
            
            function getStoredCartItems() {
                // Simulate localStorage with in-memory storage
                return window.cartItems || [];
            }
            
            function storeCartItems(items) {
                window.cartItems = items;
            }
            
            function getStoredUserData(key) {
                return window.userData?.[key] || null;
            }
            
            function storeUserData(key, value) {
                if (!window.userData) window.userData = {};
                window.userData[key] = value;
            }
            
            function removeUserData(key) {
                if (window.userData) {
                    delete window.userData[key];
                }
            }
            
            function initPage() {
                // Initialize map
                initMap();
                
                // Load cart items
                updateOrderSummary();
                
                // Set minimum delivery date to tomorrow
                setDeliveryDateMin();
                
                // Initialize event listeners
                setupEventListeners();
                
                // Check if user is logged in
                checkLoggedInStatus();
                
                // Load saved user info if available
                loadSavedUserInfo();
            }
            
            function initMap() {
                // Initialize the map
                map = L.map('map').setView([userLocation.lat, userLocation.lng], 10);
                
                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add marker
                marker = L.marker([userLocation.lat, userLocation.lng], {
                    draggable: true
                }).addTo(map);
                
                // Handle marker drag
                marker.on('dragend', function(e) {
                    const position = e.target.getLatLng();
                    userLocation = { lat: position.lat, lng: position.lng };
                    updateLocationFromCoordinates(position.lat, position.lng);
                });
                
                // Handle map click
                map.on('click', function(e) {
                    const position = e.latlng;
                    marker.setLatLng(position);
                    userLocation = { lat: position.lat, lng: position.lng };
                    updateLocationFromCoordinates(position.lat, position.lng);
                });
            }
            
            function updateLocationFromCoordinates(lat, lng) {
                // Find closest city
                let closestCity = 'Pune';
                let minDistance = Infinity;
                
                Object.entries(cityData).forEach(([city, data]) => {
                    const distance = Math.sqrt(
                        Math.pow(lat - data.lat, 2) + Math.pow(lng - data.lng, 2)
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestCity = city;
                    }
                });
                
                // Update UI
                document.getElementById('delivery-location').value = closestCity;
                updateLocationInfo(closestCity);
            }
            
            function updateLocationInfo(city) {
                const cityInfo = cityData[city];
                if (!cityInfo) return;
                
                // Update location display
                document.getElementById('current-location').textContent = city;
                document.getElementById('delivery-estimate').textContent = cityInfo.deliveryDays;
                
                // Update form fields
                document.getElementById('city').value = city;
                document.getElementById('state').value = cityInfo.state;
                
                // Update delivery options based on location
                const expressDelivery = document.getElementById('express-delivery');
                const expressLabel = document.querySelector('label[for="express-delivery"]');
                
                if (cityInfo.expressAvailable) {
                    expressDelivery.disabled = false;
                    expressLabel.classList.remove('text-gray-400');
                    expressLabel.innerHTML = 'Express Delivery (+₹99) - Next Day';
                } else {
                    expressDelivery.disabled = true;
                    expressLabel.classList.add('text-gray-400');
                    expressLabel.innerHTML = 'Express Delivery (Not available in this location)';
                    
                    // Switch to standard if express is selected
                    if (expressDelivery.checked) {
                        document.getElementById('standard-delivery').checked = true;
                        calculateTotals();
                    }
                }
            }
            
            function getProductDetails(productId) {
                // In a real app, this would come from your database/API
                const products = {
                    '1': {
                        id: '1',
                        name: 'Wireless Headphones',
                        price: 2999,
                        image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-1.2.1&auto=format&fit=crop&w=80&h=80&q=60',
                        color: 'Black'
                    },
                    '2': {
                        id: '2',
                        name: 'Smart Watch',
                        price: 7999,
                        image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-1.2.1&auto=format&fit=crop&w=80&h=80&q=60',
                        color: 'Silver'
                    },
                    '3': {
                        id: '3',
                        name: 'Phone Case',
                        price: 499,
                        image: 'https://images.unsplash.com/photo-1546868871-7041f2a55e12?ixlib=rb-1.2.1&auto=format&fit=crop&w=80&h=80&q=60',
                        color: 'Blue'
                    }
                };
                
                return products[productId];
            }
            
            function loadSavedUserInfo() {
                // Load saved user information
                const savedEmail = getStoredUserData('userEmail');
                const savedFirstName = getStoredUserData('firstName');
                const savedLastName = getStoredUserData('lastName');
                const savedPhone = getStoredUserData('phone');
                const savedAddress = getStoredUserData('address');
                const savedZip = getStoredUserData('zip');
                
                if (savedEmail) {
                    document.getElementById('email').value = savedEmail;
                }
                if (savedFirstName) {
                    document.getElementById('first-name').value = savedFirstName;
                }
                if (savedLastName) {
                    document.getElementById('last-name').value = savedLastName;
                }
                if (savedPhone) {
                    document.getElementById('phone').value = savedPhone;
                }
                if (savedAddress) {
                    document.getElementById('address').value = savedAddress;
                }
                if (savedZip) {
                    document.getElementById('zip').value = savedZip;
                }
            }
            
            function saveUserInfo() {
                // Save user information for future use
                const email = document.getElementById('email').value;
                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const phone = document.getElementById('phone').value;
                const address = document.getElementById('address').value;
                const zip = document.getElementById('zip').value;
                
                if (email) storeUserData('userEmail', email);
                if (firstName) storeUserData('firstName', firstName);
                if (lastName) storeUserData('lastName', lastName);
                if (phone) storeUserData('phone', phone);
                if (address) storeUserData('address', address);
                if (zip) storeUserData('zip', zip);
            }
            
            function updateOrderSummary() {
                const cartItems = getStoredCartItems();
                const orderItemsContainer = document.getElementById('order-items');
                const noItemsMessage = document.getElementById('no-items-message');
                
                // Clear existing items
                orderItemsContainer.innerHTML = '';
                
                if (cartItems.length === 0) {
                    noItemsMessage.classList.remove('hidden');
                    return;
                }
                
                noItemsMessage.classList.add('hidden');
                
                // Add each item to the order summary
                cartItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex';
                    itemElement.innerHTML = `
                        <div class="h-16 w-16 rounded-md overflow-hidden">
                            <img src="${item.image}" alt="${item.name}" class="h-full w-full object-cover">
                        </div>
                        <div class="ml-4 flex-1">
                            <h4 class="text-sm font-medium text-gray-800">${item.name}</h4>
                            <p class="text-xs text-gray-500">Color: ${item.color}</p>
                            <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
                        </div>
                        <div class="text-sm font-medium">₹${item.price.toFixed(2)}</div>
                    `;
                    orderItemsContainer.appendChild(itemElement);
                });
                
                // Calculate totals
                calculateTotals();
            }
            
            function calculateTotals() {
                const cartItems = getStoredCartItems();
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value || 'standard';
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'credit-card';
                
                let shippingCost = 0;
                if (deliveryType === 'express') {
                    shippingCost = 99;
                } else if (deliveryType === 'scheduled') {
                    shippingCost = 49;
                }
                
                // Add COD charges
                let codCharges = 0;
                if (paymentMethod === 'cod') {
                    codCharges = 20;
                }
                
                // Calculate tax (18% of subtotal)
                const tax = subtotal * 0.18;
                const total = subtotal + shippingCost + codCharges + tax;
                
                // Update the UI
                document.getElementById('item-count').textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('subtotal').textContent = subtotal.toFixed(2);
                document.getElementById('shipping-cost').textContent = (shippingCost + codCharges).toFixed(2);
                document.getElementById('tax').textContent = tax.toFixed(2);
                document.getElementById('total').textContent = total.toFixed(2);
            }
            
            function setDeliveryDateMin() {
                const deliveryDateInput = document.getElementById('delivery-date');
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const yyyy = tomorrow.getFullYear();
                const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const dd = String(tomorrow.getDate()).padStart(2, '0');
                
                deliveryDateInput.min = `${yyyy}-${mm}-${dd}`;
                deliveryDateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            
            function setupEventListeners() {
                // Current location button
                document.getElementById('use-current-location').addEventListener('click', function() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            userLocation = { lat, lng };
                            map.setView([lat, lng], 13);
                            marker.setLatLng([lat, lng]);
                            
                            updateLocationFromCoordinates(lat, lng);
                        }, function(error) {
                            alert('Unable to retrieve your location. Please select manually.');
                        });
                    } else {
                        alert('Geolocation is not supported by this browser.');
                    }
                });
                
                // Payment method selection
                const paymentMethods = document.querySelectorAll('input[name="payment-method"]');
                const creditCardForm = document.getElementById('credit-card-form');
                const upiForm = document.getElementById('upi-form');
                const netbankingForm = document.getElementById('netbanking-form');
                const codForm = document.getElementById('cod-form');
                
                paymentMethods.forEach(method => {
                    method.addEventListener('change', function() {
                        creditCardForm.classList.add('hidden');
                        upiForm.classList.add('hidden');
                        netbankingForm.classList.add('hidden');
                        codForm.classList.add('hidden');
                        
                        if (this.id === 'credit-card') {
                            creditCardForm.classList.remove('hidden');
                        } else if (this.id === 'paypal') {
                            upiForm.classList.remove('hidden');
                        } else if (this.id === 'apple-pay') {
                            netbankingForm.classList.remove('hidden');
                        } else if (this.id === 'cod') {
                            codForm.classList.remove('hidden');
                        }
                        
                        // Recalculate totals when payment method changes
                        calculateTotals();
                    });
                });
                
                // Delivery type selection
                document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                    radio.addEventListener('change', calculateTotals);
                });
                
                // Location selection
                document.getElementById('delivery-location').addEventListener('change', function() {
                    const location = this.value;
                    if (location && cityData[location]) {
                        const cityInfo = cityData[location];
                        
                        // Update map view
                        map.setView([cityInfo.lat, cityInfo.lng], 11);
                        marker.setLatLng([cityInfo.lat, cityInfo.lng]);
                        userLocation = { lat: cityInfo.lat, lng: cityInfo.lng };
                        
                        // Update location info
                        updateLocationInfo(location);
                    }
                });
                
                // Login button
                document.getElementById('login-btn').addEventListener('click', function() {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const remember = document.getElementById('remember').checked;
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }
                    
                    // Simulate login
                    storeUserData('userEmail', email);
                    storeUserData('isLoggedIn', 'true');
                    
                    if (remember) {
                        storeUserData('rememberMe', 'true');
                    }
                    
                    checkLoggedInStatus();
                    saveUserInfo(); // Save current form info
                });
                
                // Logout button
                document.getElementById('logout-btn').addEventListener('click', function() {
                    removeUserData('userEmail');
                    removeUserData('isLoggedIn');
                    removeUserData('rememberMe');
                    checkLoggedInStatus();
                    
                    // Clear login form
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                    document.getElementById('remember').checked = false;
                });
                
                // Guest checkout button
                document.getElementById('guest-checkout-btn').addEventListener('click', function() {
                    document.getElementById('logged-in-user').classList.add('hidden');
                    document.getElementById('login-form').classList.add('hidden');
                });
                
                // Place order button
                document.getElementById('place-order-btn').addEventListener('click', function() {
                    // Validate required fields
                    if (!validateForm()) {
                        return;
                    }
                    
                    // Save user info for future use
                    saveUserInfo();
                    
                    // In a real application, you would submit the form to your server here
                    const orderData = {
                        user: getStoredUserData('userEmail') || document.getElementById('email').value,
                        deliveryLocation: document.getElementById('delivery-location').value,
                        deliveryAddress: getDeliveryAddress(),
                        coordinates: userLocation,
                        deliveryDate: document.getElementById('delivery-date').value,
                        deliveryTime: document.getElementById('delivery-time').value,
                        deliveryType: document.querySelector('input[name="delivery-type"]:checked').value,
                        paymentMethod: document.querySelector('input[name="payment-method"]:checked').value,
                        items: getStoredCartItems(),
                        specialNote: document.getElementById('special-note').value,
                        total: parseFloat(document.getElementById('total').textContent)
                    };
                    
                    console.log('Order submitted:', orderData);
                    
                    // Show success message
                    alert('Order placed successfully! Thank you for your purchase.');
                    
                    // Clear cart
                    window.cartItems = [];
                    
                    // Redirect to confirmation page (in a real app)
                    // window.location.href = 'order-confirmation.html?id=' + orderId;
                });
            }
            
            function checkLoggedInStatus() {
                const userEmail = getStoredUserData('userEmail');
                const isLoggedIn = getStoredUserData('isLoggedIn');
                const loggedInUser = document.getElementById('logged-in-user');
                const loginForm = document.getElementById('login-form');
                
                if (userEmail && isLoggedIn) {
                    document.getElementById('user-email').textContent = userEmail;
                    loggedInUser.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    
                    // Pre-fill email in checkout form if remembered
                    if (getStoredUserData('rememberMe') === 'true') {
                        document.getElementById('email').value = userEmail;
                    }
                } else {
                    loggedInUser.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                }
            }
            
            function getDeliveryAddress() {
                return {
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    address: document.getElementById('address').value,
                    address2: document.getElementById('address2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value,
                    phone: document.getElementById('phone').value
                };
            }
            
            function validateForm() {
                const requiredFields = [
                    'first-name', 'last-name', 'address', 'city', 'state', 'zip', 
                    'phone', 'delivery-date', 'delivery-time', 'delivery-location'
                ];
                
                // Check if user is logged in or has provided email
                const userEmail = getStoredUserData('userEmail') || document.getElementById('email').value;
                if (!userEmail) {
                    alert('Please login or provide your email address');
                    return false;
                }
                
                // Check all required fields
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value) {
                        const label = field.labels ? field.labels[0].textContent : fieldId;
                        alert(`Please fill in the ${label} field`);
                        field.focus();
                        return false;
                    }
                }
                
                // Validate payment method
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
                if (!paymentMethod) {
                    alert('Please select a payment method');
                    return false;
                }
                
                // Additional validation for credit card
                if (paymentMethod.id === 'credit-card') {
                    const cardNumber = document.getElementById('card-number').value;
                    const cardExpiry = document.getElementById('card-expiry').value;
                    const cardCvc = document.getElementById('card-cvc').value;
                    const cardName = document.getElementById('card-name').value;
                    
                    if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
                        alert('Please fill in all credit card details');
                        return false;
                    }
                    
                    // Simple card number validation
                    if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                        alert('Please enter a valid 16-digit card number');
                        return false;
                    }
                    
                    // Simple expiry date validation
                    if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                        alert('Please enter a valid expiry date in MM/YY format');
                        return false;
                    }
                    
                    // Simple CVC validation
                    if (!/^\d{3,4}$/.test(cardCvc)) {
                        alert('Please enter a valid CVV (3 or 4 digits)');
                        return false;
                    }
                }
                
                // Additional validation for UPI
                if (paymentMethod.id === 'paypal') {
                    const upiId = document.getElementById('upi-id').value;
                    if (!upiId || !upiId.includes('@')) {
                        alert('Please enter a valid UPI ID');
                        return false;
                    }
                }
                
                // Additional validation for Net Banking
                if (paymentMethod.id === 'apple-pay') {
                    const bankSelect = document.getElementById('bank-select').value;
                    if (!bankSelect) {
                        alert('Please select your bank');
                        return false;
                    }
                }
                
                // Validate cart has items
                const cartItems = getStoredCartItems();
                if (cartItems.length === 0) {
                    alert('Your cart is empty. Please add items before checking out.');
                    return false;
                }
                
                return true;
            }
            
            // Initialize with some demo items if cart is empty
            if (getStoredCartItems().length === 0) {
                const demoItems = [
                    {
                        id: '1',
                        name: 'Wireless Headphones',
                        price: 2999,
                        image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-1.2.1&auto=format&fit=crop&w=80&h=80&q=60',
                        color: 'Black',
                        quantity: 1
                    },
                    {
                        id: '2',
                        name: 'Smart Watch',
                        price: 7999,
                        image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?ixlib=rb-1.2.1&auto=format&fit=crop&w=80&h=80&q=60',
                        color: 'Silver',
                        quantity: 1
                    }
                ];
                storeCartItems(demoItems);
            }
        });
    </script>
</body>
</html>